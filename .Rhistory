observeEvent(input$grant_num,{
grant_vals$percent_disbursed <- current_dashboard %>%
filter(Child_TF == 'TF0A3608') %>% select(`Total Disbursed`) %>%
as.numeric()
current_dashboard %>%
filter(Child_TF == 'TF0A3608') %>% select(`Total Disbursed`) %>%
as.numeric()
current_dashboard %>%
filter(Child_TF == 'TF0A3608') %>% select(`Total Disbursed`) %>%
as.numeric()
current_dashboard %>%
filter(Child_TF == 'TF0A3608') %>% select(`Total Disbursed`) %>%
as.numeric()
current_dashboard %>%
filter(Child_TF == 'TF0A3608') %>% select(`Total Disbursed`) %>%
as.numeric()
current_dashboard %>%
filter(Child_TF == 'TF0A3608') %>% select(`Total Disbursed`) %>%
as.numeric()
current_dashboard %>%
filter(Child_TF == 'TF0A3608') %>% select(`Total Disbursed`) %>%
as.numeric()
current_dashboard %>%
filter(Child_TF == 'TF0A3608') %>% select(`Total Disbursed`) %>%
as.numeric()
current_dashboard %>%
filter(Child_TF == 'TF0A3608') %>% summarise('percent_dis' = (sum(`Total Disbursed`/sum(`TF Amount`))*100)) %>%
as.numeric()
runApp('World_Bank/GFDRR/R_code/GFDRRdash')
?renderText
runApp('World_Bank/GFDRR/R_code/GFDRRdash')
runApp()
runApp()
runApp()
runApp('World_Bank/GFDRR/R_code/GFDRRdash')
runApp('World_Bank/GFDRR/R_code/GFDRRdash')
runApp('World_Bank/GFDRR/R_code/GFDRRdash')
runApp('World_Bank/GFDRR/R_code/GFDRRdash')
runApp('World_Bank/GFDRR/R_code/GFDRRdash')
View(vlookup)
library(DBI)
db <- dbConnect(RSQLite::SQLite(), "~/Downloads/venezuela-sql-master/venezuela.sql")
install.packages("RODBC")
help.package(RODBC)
help(package=RODBC)
getSQL <- function(filepath){
con = file(filepath, "r")
sql.string <- ""
while (TRUE){
line <- readLines(con, n = 1)
if ( length(line) == 0 ){
break
}
line <- gsub("\\t", " ", line)
if(grepl("--",line) == TRUE){
line <- paste(sub("--","/*",line),"*/")
}
sql.string <- paste(sql.string, line)
}
close(con)
return(sql.string)
}
getSQL("~/Downloads/venezuela-sql-master/venezuela.sql")
getSQL("~/Downloads/venezuela-sql-master/venezuela.sql") %>% as.data.frame()
getSQL("~/Downloads/venezuela-sql-master/venezuela.sql") %>% as.data.frame() %>% view()
getSQL("~/Downloads/venezuela-sql-master/venezuela.sql") %>% as.data.frame() %>% View()
df <- dbGetQuery(db,statement = read_file("~/Downloads/venezuela-sql-master/venezuela.sql"))
library(readr)
dbGetQuery(db,statement = read_file("~/Downloads/venezuela-sql-master/venezuela.sql"))
read_file("~/Downloads/venezuela-sql-master/venezuela.sql")
db <- dbConnect(RSQLite::SQLite(), "~/Downloads/venezuela-sql-master/venezuela.sql")
dbListTables(db)
db <- dbConnect(RSQLite::SQLite(), "~/Downloads/venezuela-sql-master/venezuela.sql",synchronous=FALSE)
db <- dbConnect(RSQLite::SQLite(), "~/Downloads/venezuela-sql-master/venezuela.sql",synchronous=NULL)
dbListTables(db)
db
dbGetQuery(db,statement = read_file("~/Downloads/venezuela-sql-master/venezuela.sql"))
df <- dbGetQuery(db)
shiny::runApp('World_Bank/GFDRR/Shiny_Dashboards/TTLs')
runApp('~/World_Bank/GFDRR/Shiny_Dashboards/Secretariat')
#create Akiko report
library(readxl)
data <- read_xlsx(path = "Downloads/GFDRR Dashoard grant level 12_2_19.xlsx")
View(data)
codes <- read_xlsx(path = "Downloads/GPs rename - raw data .xlsx")
View(codes)
codes %>% select(`GP Rename`, `TTL Unit Name`)
codes %>% select(`GP Rename`, `TTL Unit Name`,GPs)
codes %>% select(`GP Rename`, `TTL Unit Name`,`TTL Unit`)
codes %>% select(`GP Rename`, `TTL Unit Name`,`TTL Unit`) %>% group_by(`GP Rename`)
codes %>% select(`GP Rename`, `TTL Unit Name`,`TTL Unit`) %>% group_by(`GP Rename`,`TTL Unit Name`)
codes %>% select(`GP Rename`, `TTL Unit Name`,`TTL Unit`) %>% group_by(`GP Rename`) %>% summarise()
codes %>% select(`GP Rename`, `TTL Unit Name`,`TTL Unit`) %>%
group_by(`GP Rename`) %>%
summarise(Unit=`TTL Unit Name`)
codes %>% select(`GP Rename`, `TTL Unit Name`,`TTL Unit`) %>%
distinct() %>% arrange(`GP Rename`)
codes %>% select(`GP Rename`, `TTL Unit Name`,`TTL Unit`) %>%
distinct() %>% arrange(-`GP Rename`)
codes %>% select(`GP Rename`, `TTL Unit Name`,`TTL Unit`) %>%
distinct() %>% arrange(`GP Rename`,descending=FALSE)
codes %>% select(`GP Rename`, `TTL Unit Name`,`TTL Unit`) %>%
distinct() %>% arrange(`GP Rename`,ascending=FALSE)
codes %>% select(`GP Rename`, `TTL Unit Name`,`TTL Unit`) %>%
distinct() %>% arrange(`GP Rename`) %>% View()
codes_raw <- read_xlsx(path = "Downloads/GPs rename - raw data .xlsx")
codes <- codes_raw %>% select(`GP Rename`, `TTL Unit Name`,`TTL Unit`) %>%
distinct() %>% arrange(`GP Rename`)
codes <- codes[complete.cases(codes), ]
View(codes)
write.csv(codes,file='Downloads/codes.csv')
GPs <- read_xlsx("Downloads/Knowledge_Activities_Table_A8.1 ASA Activity Details - Active.xlsx")
VIew(GPs)
View(GPs)
GPs <- read_xlsx("Downloads/Knowledge_Activities_Table_A8.1 ASA Activity Details - Active.xlsx",skip = 3)
View(GPs)
GP_units <- GPs %>%  select(`Resp. Unit`,`Lead GP/Global Themes`)
GP_units <- GPs %>%  select(`Resp. Unit`,`Lead GP/Global Themes`) %>% dplyr::distinct()
View(GP_units)
write.csv(GP_units,file='Downloads/GP_units.csv')
GPs <- read_xlsx("Downloads/Knowledge_Activities_Table_A8.1 ASA Activity Details - Active.xlsx",skip = 3)
GP_units <- GPs %>%  select(`Resp. Unit`,`Lead GP/Global Themes`) %>% dplyr::distinct()
write.csv(GP_units,file='Downloads/GP_units.csv')
data <- read_xlsx(path="Downloads/Andres_GFDRR Dashoard grant level 12_2_19.xlsx")
View(data)
data <- read_xlsx(path="Downloads/Andres_GFDRR Dashoard grant level 12_2_19.xlsx")
data %>% filter(`Fund Status`=="ACTV",`Fund Country Region Name`=="AFR")
data %>% filter(`Fund Status`=="ACTV",`Fund Country Region Name`=="AFRICA")
AFR <- data %>% filter(`Fund Status`=="ACTV",`Fund Country Region Name`=="AFRICA")
unique(AFR$recode.2)
AFR$GPURL_binary <- ifelse(AFR$recode.2=="Urban, Resilience and Land","GPURL","Non-GPURL")
View(AFR)
GPURL <- AFR %>% filter(GPURL_binary=='GPURL')
non_GPURL <- AFR %>% filter(GPURL_binary!='GPURL')
View(non_GPURL)
names(AFR)
AFR.1 <- AFR %>% dplyr::distinct() %>% mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`)
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`) %>%
group_by(Country) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=sum(balance))
AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`)
AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`) %>% names()
AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`) %>%
group_by(Country) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=sum(balance))
AFR.1 <- AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`) %>%
group_by(Country) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=sum(balance))
AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`) %>%
group_by(Country) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=round(sum(balance),0))
AFR.1 <- AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`) %>%
group_by(Country) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=round(sum(balance),0))
View(AFR.1)
AFR.1 <- AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`,
regional=ifelse(Country %in% c("Africa","Central Africa","Southern Africa"),"yes","no")) %>%
group_by(Country) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=round(sum(balance),0))
AFR.1 <- AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`,
regional=ifelse(Country %in% c("Africa","Central Africa","Southern Africa"),"yes","no")) %>%
group_by(Country,regional) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=round(sum(balance),0))
View(AFR.1)
AFR.1 <- AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`,
regional=ifelse(Country %in% c("Africa","Central Africa","Southern Africa"),"yes","no")) %>%
group_by(Country,regional) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=round(sum(balance),0)) %>%
arrange(regional) %>%
select(-regional)
View(AFR.1)
AFR.1 <- AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`,
regional=ifelse(Country %in% c("Africa","Central Africa","Southern Africa"),"yes","no")) %>%
group_by(Country,regional) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=round(sum(balance),0)) %>%
arrange(-regional) %>%
select(-regional)
AFR.1 <- AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`,
regional=ifelse(Country %in% c("Africa","Central Africa","Southern Africa"),"yes","no")) %>%
group_by(Country,regional) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=round(sum(balance),0)) %>%
sort(regional) %>%
select(-regional)
AFR.1 <- AFR %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`,
regional=ifelse(Country %in% c("Africa","Central Africa","Southern Africa"),1,0)) %>%
group_by(Country,regional) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=round(sum(balance),0)) %>%
arrange(-regional) %>%
select(-regional)
View(AFR.1)
GPURL.1 <- GPURL %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`,
regional=ifelse(Country %in% c("Africa","Central Africa","Southern Africa"),1,0)) %>%
group_by(Country,regional) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=round(sum(balance),0)) %>%
arrange(-regional) %>%
select(-regional)
non_GPURL.1 <- non_GPURL %>% dplyr::distinct() %>%
mutate(balance=`Grant Amount USD`-`Disbursements USD`-`Commitments USD`,
regional=ifelse(Country %in% c("Africa","Central Africa","Southern Africa"),1,0)) %>%
group_by(Country,regional) %>%
summarise(n.grants=n(), "amount"=sum(`Grant Amount USD`), balance=round(sum(balance),0)) %>%
arrange(-regional) %>%
select(-regional)
View(non_GPURL.1)
test <- full_join(AFR.1,GPURL.1,by="Country")
View(test)
test <- full_join(AFR.1,GPURL.1,non_GPURL.1,by="Country")
View(test)
test.2 <- full_join(test,non_GPURL.1,by="Country")
test.2
View(test.2)
joint.1 <- full_join(AFR.1,GPURL.1,by="Country")
joint.2 <- full_join(test,non_GPURL.1,by="Country")
write.csv(joint.2,file = "World_Bank/AFR_update.csv")
2+2
knitr::opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE)
data %>% filter(!(is.na(`G/L Account`)))
knitr::opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE)
library(readxl)
library(dplyr)
library(ggplot2)
library(scales)
library(plotly)
library(DT)
data <- read_xlsx('Disbursements Details as of 12_12_19.xlsx')
summary_data <- read_xls('Disbursements Summary as of 12_12_19.xls')
summary_data$`Expense Categories`[is.na(summary_data$`Expense Categories`)] <- "Total"
# remove columns where all values are zero(0)
summary_data <- summary_data[, colSums(summary_data != 0) > 0]
summary_data %>% mutate(
FY20 = dollar(FY20),
FY19 = dollar(FY19),
`Cumulative Disbursement` = dollar(`Cumulative Disbursement`)
) %>%  DT::datatable(
elementId = "test",
caption = 'testing',
extensions = 'Buttons',
options = list(dom = 'rtBip',
buttons = c('excel', "csv"))
) #end of datatable
gg_summary_data <- summary_data  %>%
select(-`Cumulative Disbursement`) %>%
filter(`Expense Categories`!="Total") %>%
reshape2::melt() %>%
rename("Fiscal Year"=variable) %>%
ggplot(aes(x=`Expense Categories`,y=value,fill=`Fiscal Year`)) +
geom_col() +
theme_minimal()+
scale_y_continuous(labels=dollar_format(prefix="$")) +
labs(y="USD Amount",title="Disbursement Summary")
ggplotly(gg_summary_data)  %>%
layout(autosize = F, width = 1000, height = 500)
data <- data %>% filter(!(is.na(`G/L Account`)))
data$`Consultant/Vendor Name`[is.na(data$`Consultant/Vendor Name`)] <- "Other"
table.1 <- data %>% group_by(`Consultant/Vendor Name`) %>%
summarise(`Amount USD`=sum(`Amount USD`)) %>%
arrange(-`Amount USD`) %>%
mutate(`Amount USD`= dollar(`Amount USD`))
table.2 <- data %>% select(`Consultant/Vendor Name`,`Trust Fund`) %>%
dplyr::distinct(.keep_all=TRUE) %>%
group_by(`Consultant/Vendor Name`) %>%
summarise("Child Funds Charged" = paste0(`Trust Fund`, collapse = ";"))
full_join(table.1,table.2) %>% View()
library(xlsx)
install.packages('rjava')
install.packages('rJava')
library(xlsx)
help(package=openxlsx)
shiny::runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
?downloadHandler()
runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
?saveWorkbook
runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
?copyWorkbook()
runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
shiny::runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
date_data_udpated
runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
recode_GT %>% names()
which(recode_GT$`Lead GP/Global Themes`=="Climate Change")
recode_GT[which(recode_GT$`Lead GP/Global Themes`=="Climate Change"),]
runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
# PACKAGES ----------------------------------------------------------------
library(readxl)
library(dplyr)
library(stringi)
library(lubridate)
options(scipen = 999)
# READ IN DATA ------------------------------------------------------------
#NEEDS UPDATING
grants_file <- "GFDRR Dashboard grant level 12_3_19.xlsx"
sap <- read_xlsx('SAP Data as of June 30_2019.xlsx')
grants <- read_xlsx(grants_file)
date_data_udpated <- lubridate::mdy(stri_sub(grants_file,from = -13,-6))
#dash <- read_xlsx('GFDRR Dashboard - 201910.xlsx', sheet = 3, skip = 2)
#trustee <- read_xls('GFDRR_mg_unit.xls', skip=2)
trustee <- read_xlsx('GFDRR Trustee level 12_2_19.xlsx')
#recode_trustee.1 <- read_xlsx('recodes.xlsx',sheet=1) %>% select(-Status)
recode_trustee.2 <- read_xlsx("GFDRR Trustee Names.xlsx")
recode_region <- read_xlsx('recodes.xlsx',sheet=2)
recode_GT <- read_xlsx("Global Theme - Resp. Unit Mapping.xlsx")
SR_grant_details <- read_xlsx("Trust_Fund_Breakdown_Table_TF4.1 Grant Details Report.xlsx",skip=3)
expenses <- read.csv(file='V2_GFDRR TF Expense Details - FY18 and FY19 YTD(AutoRecovered).csv',
stringsAsFactors = FALSE,col.names =  c("Disbursing.Trust.Fund",
"Disbursing.Trust.Fund.Description",
"TF.Status",
"Task.team.Leader",
"Managing.Unit",
"Region",
"Global.Practice",
"Trustee",
"Trustee.Description",
"TF.Creation.date",
"TF.Closing.Date",
"Cost.Object",
"Cost.Object.Description",
"Commitment.item",
"Commitment.Item.Group",
"Disbursements.FY.2018",
"Disbursements.FY.2019...YTD.Feb.2019"))[1:6958,1:17]
expenses <- expenses %>% mutate(Disbursements.FY.2018=as.numeric(Disbursements.FY.2018),
Disbursements.FY.2019...YTD.Feb.2019=as.numeric(Disbursements.FY.2019...YTD.Feb.2019))
#create a new df with only active trustees and with recoded names
trustee$still_days_to_disburse <- as.Date(trustee$`TF End Disb Date`) > today()
active_trustee <- trustee %>% filter(still_days_to_disburse==TRUE)
active_trustee <- left_join(active_trustee,recode_trustee.2,by=c("Fund"="Trustee")) %>%
rename("Trustee.name"=`Trustee Fund Name`)
#add short region name to SAP data
grants <- full_join(grants,recode_region,by=c("Fund Country Region Name"='Region_Name'))
#filter out grants that have 0
grants <- grants %>% filter(`Grant Amount USD`>0)
grants <- grants %>% filter(`Fund Status`=="ACTV")
#add lead GP/Global Themes name to SAP grant data ****This will need to be changed to dinamically account for changes***
alt_GT <- SR_grant_details %>% select(`Grant No.`,`Lead GP/Global Themes`) %>% rename("Fund"=`Grant No.`)
grants <- left_join(grants,alt_GT,by="Fund")
#identify and create a new variable for grants without Global Theme
homeless_TFs <- grants %>% filter(is.na(`Lead GP/Global Themes`)) %>%
select(Fund,`TTL Unit Name`)
#assign global theme to grant based on Grant TTL unit
recode_GT$`Lead GP/Global Themes`[which(recode_GT$`Lead GP/Global Themes`=="Climate Change")] <- "Climate Change/GFDRR"
homed_TFs <- left_join(homeless_TFs,recode_GT,by=c("TTL Unit Name"="Resp. Unit")) %>%
select(Fund,`Lead GP/Global Themes`)
grants$`Lead GP/Global Themes`[is.na(grants$`Lead GP/Global Themes`)] <-
homed_TFs$`Lead GP/Global Themes`[homed_TFs$Fund==grants$Fund[is.na(grants$`Lead GP/Global Themes`)]]
#create a  new column with pseudo final TRUSTEE names to display
#this is just in case not all desired names have been provided by GFDRR
active_trustee$temp.name <- NA
for (i in 1:nrow(active_trustee)){
if (is.na(active_trustee$Trustee.name[i])){
active_trustee$temp.name[i] <- active_trustee$`Fund Name`[i]
} else
{active_trustee$temp.name[i] <- active_trustee$Trustee.name[i]}
}
elapsed_months <- function(end_date, start_date) {
ed <- as.POSIXlt(end_date)
sd <- as.POSIXlt(start_date)
12 * (ed$year - sd$year) + (ed$mon - sd$mon)
}
active_trustee$months_to_end_disbursement <-
elapsed_months(active_trustee$`TF End Disb Date`,today())
active_trustee$months_to_end_disbursement_static <-
elapsed_months(active_trustee$`TF End Disb Date`,date_data_udpated)
grants$months_to_end_disbursement <-
elapsed_months(grants$`Closing Date`,today())
grants$months_to_end_disbursement_static <-
elapsed_months(grants$`Closing Date`,date_data_udpated)
# add a column with Trustee temporary name V
grants <- full_join(grants,active_trustee %>%
filter(Fund %in% trustee$Fund) %>%
select(temp.name,Fund),
by = c("Trustee"="Fund")) %>%
filter(!is.na(Fund))
grants$closing_FY <- ifelse(month(grants$`Closing Date`) > 6,
year(grants$`Closing Date`) + 1,
year(grants$`Closing Date`))
grants$remaining_balance <- grants$`Grant Amount USD` - grants$`Disbursements USD`
grants$unnacounted_amount <- grants$`Grant Amount USD` -
(grants$`Disbursements USD` + grants$`Commitments USD`)
grants$percent_unaccounted <- (grants$unnacounted_amount * 100 ) / grants$`Grant Amount USD`
grants$tf_age_months <- elapsed_months(today(),grants$`Activation Date`)
grants$planned_tf_duration_months <- elapsed_months(grants$`Closing Date`,
grants$`Activation Date`)
grants$time_ratio <- (grants$tf_age_months/grants$planned_tf_duration_months)
grants$disbursement_rate <- ifelse(grants$`Disbursements USD`>0,
(grants$`Disbursements USD`/grants$`Grant Amount USD`),
0)
grants$monthly_disbursement_rate <- ifelse(grants$`Disbursements USD`>0,
(grants$`Disbursements USD`/grants$`Grant Amount USD`)/grants$tf_age_months,
0)
grants$completion_gap <- grants$time_ratio - grants$disbursement_rate
grants$burn_rate <- (grants$`Disbursements USD`/ grants$tf_age_months)
grants$percent_remaining <- grants$remaining_balance/grants$`Grant Amount USD`
grants$required_disbursement_rate <- (grants$unnacounted_amount/grants$`Grant Amount USD`)/
grants$months_to_end_disbursement
grants$required_disbursement_rate <- ifelse(grants$required_disbursement_rate==Inf,
grants$percent_unaccounted/100,
grants$required_disbursement_rate)
compute_risk_level <- function (x){
risk_level <- ifelse(x < .03,"Low Risk",
ifelse(x < .05,"Medium Risk",
ifelse(x < .10,"High Risk",
"Very High Risk")))
return(risk_level)
}
grants$disbursement_risk_level <- compute_risk_level(grants$required_disbursement_rate)
compute_risk_color<- function (x){
risk_color <- ifelse(x<.03,"green",
ifelse(x<.05,"yellow",
ifelse(x<.10,"orange",
"red")))
return(risk_color)
}
grants$disbursement_risk_color <- compute_risk_color(grants$required_disbursement_rate)
#compute adjusted transfers (accounting for transfers out)
grants$adjusted_transfer <- grants$`Transfer-in USD` - grants$`Transfers-out in USD`
#compute percentage of what was transferred that is available
grants$percent_transferred_available <- grants$`Available Balance USD`/grants$adjusted_transfer
#percent amount that is still available to be transferred
grants$funds_to_be_transferred <- grants$`Grant Amount USD` - grants$adjusted_transfer
#compute percentage of total grant that still needs to be transferred
grants$percent_left_to_transfer <- grants$funds_to_be_transferred/grants$`Grant Amount USD`
#two step process to identify PMA grants:
#step 1
grants$PMA <- ifelse(is.na(grants$`Project ID`),'yes','no')
#step 2
#remove_just-in-time from PMA
grants$PMA <- ifelse(stringi::stri_detect(tolower(grants$`Fund Name`),
fixed=tolower('Just-in-Time')),
'no',
grants$PMA)
PMA_grants <- grants %>% filter(PMA=='yes',`Fund Status`=="ACTV")
PMA_expenses <- expenses %>% filter(Disbursing.Trust.Fund %in% PMA_grants$Fund)
n_months <- PMA_grants$months_to_end_disbursement_static[which.max(PMA_grants$months_to_end_disbursement_static)]
list_monthly_resources <- rep(list(0),n_months)
list_grant_df <- rep(list(0),nrow(PMA_grants))
first_date <- as_date(date_data_udpated) %>% floor_date(unit = "months")
for (i in 1:nrow(PMA_grants)){
temp_max_months <- PMA_grants$months_to_end_disbursement_static[i]
temp_max_months <- ifelse(temp_max_months==0,1,temp_max_months)
monthly_allocation <- (PMA_grants$unnacounted_amount[i])/(ifelse(temp_max_months>0,
temp_max_months,
1))
temp_df <- data_frame(fund=rep(as.character(PMA_grants$Fund[i]),temp_max_months),
fund_name=rep(as.character(PMA_grants$`Fund Name`[i]),temp_max_months),
trustee=rep(as.character(PMA_grants$Trustee[i]),temp_max_months),
fund_TTL=rep(as.character(PMA_grants$`Fund TTL Name`[i]),temp_max_months),
sub_date = first_date %m+% months(c(0:(temp_max_months-1))),
amount=rep(monthly_allocation,temp_max_months)
)
list_grant_df[[i]] <- temp_df
for (j in 1:temp_max_months){
list_monthly_resources[[j]] <- list_monthly_resources[[j]] + monthly_allocation
}
#print(list_monthly_resources[[1]])
}
gg_data <- do.call(rbind,list_grant_df)
data <- data.frame(month_num=1:n_months,
amount_available=unlist(list_monthly_resources))
data$dates <- first_date %m+% months(c(0:(nrow(data)-1)))
data$yearmonth <- paste0(year(data$dates),ifelse(month(data$dates)<10,
paste0(0,month(data$dates)),
month(data$dates)))
gg_data$yearmonth <- paste0(year(gg_data$sub_date),ifelse(month(gg_data$sub_date)<10,
paste0(0,month(gg_data$sub_date)),
month(gg_data$sub_date)))
data$yearquarter<- paste0(as.numeric(year(data$dates)),as.numeric(quarter(data$dates)))
gg_data$yearquarter<- paste0(as.numeric(year(gg_data$sub_date)),
as.numeric(quarter(gg_data$sub_date)))
data$quarterr <- zoo::as.yearqtr(data$dates)
gg_data$quarterr <- zoo::as.yearqtr(gg_data$sub_date)
gg_data$quarter_lubri <- lubridate::quarter(gg_data$sub_date,with_year = TRUE)
grouped_gg_data <- gg_data %>%
mutate(quarterr=as_date(quarterr)) %>%
group_by(quarterr,fund_name,fund,yearquarter) %>%
summarise(amount=sum(amount))
quarterly_total <- gg_data %>% mutate(quarterr=as_date(quarterr)) %>%
group_by(quarterr) %>% summarise(Q_amount=sum(amount))
grouped_gg_data <- full_join(grouped_gg_data,quarterly_total,by="quarterr")
gg_df <- grouped_gg_data %>% filter(yearquarter<20210)
recode_GT$`Lead GP/Global Themes` %>% unique()
runApp('World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring')
recode_GT <- read_xlsx("Global Theme - Resp. Unit Mapping.xlsx")
setwd("~/World_Bank/GFDRR/Shiny_Dashboards/Github_Code/GFDRR_Grant-Monitoring")
recode_GT <- read_xlsx("Global Theme - Resp. Unit Mapping.xlsx")
recode_GT$`Lead GP/Global Themes` %>% unique()
SR_grant_details$`Lead GP/Global Themes`
SR_grant_details$`Lead GP/Global Themes` %>% unique()
runApp()
?plotly()
?plot_ly()
schema()
install.packages('listviewer')
schema()
runApp()
runApp()
